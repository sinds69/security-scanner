<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Watermark Hotel - Security Checklist</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}

html,body{
  width:100%;
  height:100%;
  overflow:hidden;
}

body{
  background:#0f172a;
  color:#fff;
  font-family:Arial,sans-serif;
  display:flex;
  flex-direction:column;
  align-items:center;
}

/* ===== HEADER ===== */
.header{
  padding-top:30px;
  text-align:center;
}
.header h1{font-size:34px}
.header h2{font-size:26px;opacity:.8;font-weight:normal}

/* ===== CONTENT ===== */
.content{
  flex:1;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:20px;
}

/* ===== SCAN BUTTON ===== */
.scan-btn{
  background:#22c55e;
  color:#022c22;
  font-size:22px;
  padding:26px;
  border:none;
  border-radius:16px;
  width:85%;
  max-width:320px;
  cursor:pointer;
}

/* ===== CAMERA READER ===== */
#reader{
  width:280px;
  height:280px;
  max-width:80vw;
  max-height:80vw;
  display:none;

  background:black;
  border-radius:16px;
  overflow:hidden;
}

#reader video{
  width:100%;
  height:100%;
  object-fit:cover;
}

/* ===== ACTION BUTTONS ===== */
.actions{
  display:none;
  gap:12px;
}

.actions button{
  padding:14px 22px;
  font-size:16px;
  border-radius:12px;
  border:none;
  cursor:pointer;
}

.retry{background:#facc15;color:#422006}
.cancel{background:#ef4444;color:#fff}

/* ===== FOOTER ===== */
.footer{
  font-size:12px;
  opacity:.6;
  padding-bottom:10px;
}
</style>
</head>

<body>

<div class="header">
  <h1>Watermark Hotel</h1>
  <h2>Security Checklist</h2>
</div>

<div class="content">
  <button id="scanBtn" class="scan-btn" onclick="startScan()">Tap Here to Scan QR</button>

  <div id="reader"></div>

  <div class="actions" id="actions">
    <button class="retry" onclick="retryScan()">Retry</button>
    <button class="cancel" onclick="cancelScan()">Cancel</button>
  </div>
</div>

<div class="footer">Â© Copyright by SIN</div>

<script>
let qrInstance=null;
let videoStream=null;
let locked=false;
let timeoutId=null;

/* ===== START SCAN ===== */
function startScan(){
  locked=false;
  hideButtons();
  document.getElementById("scanBtn").style.display="none";
  document.getElementById("reader").style.display="block";

  if("BarcodeDetector" in window){
    startNativeScanner();
  }else{
    startHtml5Scanner();
  }

  timeoutId=setTimeout(showRetryCancel,15000);
}

/* ===== NATIVE SCANNER ===== */
async function startNativeScanner(){
  try{
    const reader=document.getElementById("reader");
    reader.innerHTML="";

    const video=document.createElement("video");
    video.setAttribute("playsinline",true);
    video.style.width="100%";
    video.style.height="100%";
    video.style.objectFit="cover";
    reader.appendChild(video);

    videoStream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:"environment"}
    });

    video.srcObject=videoStream;
    await video.play();

    const detector=new BarcodeDetector({formats:["qr_code"]});

    const loop=async()=>{
      if(locked) return;
      const codes=await detector.detect(video);
      if(codes.length){
        locked=true;
        cleanup();
        redirect(codes[0].rawValue);
      }else{
        requestAnimationFrame(loop);
      }
    };
    loop();

  }catch(e){
    startHtml5Scanner();
  }
}

/* ===== HTML5 FALLBACK ===== */
function startHtml5Scanner(){
  qrInstance=new Html5Qrcode("reader");
  qrInstance.start(
    {facingMode:"environment"},
    {
      fps:5,
      aspectRatio:1,
      disableFlip:true
    },
    text=>{
      if(locked) return;
      locked=true;
      cleanup();
      redirect(text);
    }
  );
}

/* ===== UTIL ===== */
function redirect(text){
  if(!/^https?:\/\//i.test(text)){
    text="https://"+text;
  }
  window.location.replace(text);
}

function cleanup(){
  clearTimeout(timeoutId);
  if(qrInstance){
    qrInstance.stop().catch(()=>{});
    qrInstance=null;
  }
  if(videoStream){
    videoStream.getTracks().forEach(t=>t.stop());
    videoStream=null;
  }
}

function showRetryCancel(){
  cleanup();
  document.getElementById("actions").style.display="flex";
}

function retryScan(){
  document.getElementById("actions").style.display="none";
  startScan();
}

function cancelScan(){
  cleanup();
  document.getElementById("reader").style.display="none";
  document.getElementById("actions").style.display="none";
  document.getElementById("scanBtn").style.display="block";
}
</script>

</body>
</html>
