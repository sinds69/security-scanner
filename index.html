<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Watermark Hotel - Security Checklist</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
* { margin:0; padding:0; box-sizing:border-box; }

html, body {
  width:100%;
  height:100%;
  overflow:hidden;
}

body {
  font-family: Arial, sans-serif;
  background:#0f172a;
  color:white;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  align-items:center;
  text-align:center;
  height:100svh;
}

.header { margin-top:30px; }
h1 { font-size:34px; }
h2 { font-size:26px; opacity:0.8; }

.content {
  flex:1;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
}

button {
  font-size:22px;
  padding:24px;
  border-radius:15px;
  border:none;
  width:85%;
  max-width:320px;
}

#scanBtn {
  background:#22c55e;
  color:#022c22;
}

#retryBtn {
  background:#f97316;
  color:white;
  display:none;
  margin-top:20px;
}

#reader {
  width:90%;
  max-width:320px;
  margin-top:20px;
  display:none;
}

.footer {
  font-size:12px;
  opacity:0.6;
  padding-bottom:10px;
}
</style>
</head>

<body>

<div class="header">
  <h1>Watermark Hotel</h1>
  <h2>Security Checklist</h2>
</div>

<div class="content">
  <button id="scanBtn">Tap Here to Scan QR</button>
  <div id="reader"></div>
  <button id="retryBtn">Retry Scan</button>
</div>

<div class="footer">© Copyright by SIN</div>

<script>
let locked = false;
let qrInstance = null;
let videoStream = null;
let timeoutHandle = null;
const TIMEOUT = 10000;

const scanBtn = document.getElementById("scanBtn");
const retryBtn = document.getElementById("retryBtn");
const reader = document.getElementById("reader");

scanBtn.addEventListener("click", () => {
  // 1️⃣ UPDATE UI DULU
  scanBtn.style.display = "none";
  retryBtn.style.display = "none";
  reader.style.display = "block";

  // 2️⃣ PAKSA REPAINT
  requestAnimationFrame(() => {
    startScan();
  });
});

retryBtn.addEventListener("click", () => {
  stopAll();
  scanBtn.style.display = "none";
  retryBtn.style.display = "none";
  reader.style.display = "block";

  requestAnimationFrame(() => {
    startScan();
  });
});

function startScan() {
  locked = false;
  startTimeout();

  if ('BarcodeDetector' in window) {
    startNative();
  } else {
    startHtml5();
  }
}

function startTimeout() {
  timeoutHandle = setTimeout(() => {
    stopAll();
    retryBtn.style.display = "block";
  }, TIMEOUT);
}

/* ===== Native Chrome ===== */
async function startNative() {
  try {
    reader.innerHTML = "";
    const video = document.createElement("video");
    video.setAttribute("playsinline", true);
    reader.appendChild(video);

    videoStream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:"environment" }
    });

    video.srcObject = videoStream;
    await video.play();

    const detector = new BarcodeDetector({ formats:["qr_code"] });

    const loop = async () => {
      if (locked) return;
      const codes = await detector.detect(video);
      if (codes.length) {
        locked = true;
        clearTimeout(timeoutHandle);
        stopAll();
        redirect(codes[0].rawValue);
      } else {
        requestAnimationFrame(loop);
      }
    };
    loop();
  } catch {
    startHtml5();
  }
}

/* ===== Fallback ===== */
function startHtml5() {
  qrInstance = new Html5Qrcode("reader");
  qrInstance.start(
    { facingMode:"environment" },
    { fps:5, aspectRatio:1 },
    (text) => {
      if (locked) return;
      locked = true;
      clearTimeout(timeoutHandle);
      qrInstance.stop().then(() => redirect(text));
    },
    () => {}
  );
}

function redirect(text) {
  if (!text.startsWith("http")) text = "https://" + text;
  window.location.replace(text);
}

function stopAll() {
  clearTimeout(timeoutHandle);

  if (videoStream) {
    videoStream.getTracks().forEach(t => t.stop());
    videoStream = null;
  }
  if (qrInstance) {
    qrInstance.stop().catch(()=>{});
    qrInstance = null;
  }
}
</script>

</body>
</html>
